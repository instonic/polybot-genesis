<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polybot Genesis - Multi-Agent AI Dispatch</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        :root {
            /* Brand Colors */
            --primary-color: #667eea;
            --primary-dark: #764ba2;
            --primary-light: #8b9bff;
            --secondary-color: #f7fafc;
            --accent-color: #4299e1;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --error-color: #f56565;
            
            /* Text Colors */
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --text-muted: #a0aec0;
            --text-inverse: #ffffff;
            
            /* Background Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --bg-tertiary: #edf2f7;
            --bg-overlay: rgba(255, 255, 255, 0.98);
            
            /* Border & Divider */
            --border-color: #e2e8f0;
            --border-color-light: #f1f5f9;
            --divider-color: #cbd5e0;
            
            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
            
            /* Spacing Grid */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            --space-16: 64px;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Typography */
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            
            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;
            
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            font-size: var(--font-size-base);
            line-height: var(--line-height-normal);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Main App Container */
        .app-container {
            display: flex;
            min-height: 100vh;
            background: var(--bg-overlay);
            backdrop-filter: blur(10px);
        }

        /* Pane Divider */
        .pane-divider {
            width: 1px;
            background: var(--divider-color);
            box-shadow: var(--shadow-sm);
        }

        /* Left Panel - Control Panel */
        .left-panel {
            width: 30%;
            min-width: 360px;
            max-width: 480px;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .panel-header {
            padding: var(--space-6);
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: var(--text-inverse);
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: var(--shadow-md);
        }

        .panel-header h1 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-1);
            letter-spacing: -0.025em;
        }

        .panel-header p {
            font-size: var(--font-size-sm);
            opacity: 0.9;
            font-weight: var(--font-weight-medium);
        }

        .control-sections {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-6);
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .control-sections::-webkit-scrollbar {
            width: 6px;
        }

        .control-sections::-webkit-scrollbar-track {
            background: transparent;
        }

        .control-sections::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: var(--radius-full);
        }

        .control-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            border: 1px solid var(--border-color-light);
            transition: var(--transition-base);
        }

        .control-section:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
            border-color: var(--border-color);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(to bottom, var(--primary-color), var(--primary-dark));
            border-radius: var(--radius-sm);
        }

        /* AI Models Selection */
        .models-grid {
            display: grid;
            gap: var(--space-3);
        }

        .model-checkbox {
            display: flex;
            align-items: center;
            padding: var(--space-3) var(--space-4);
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-base);
            position: relative;
        }

        .model-checkbox:hover {
            border-color: var(--accent-color);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .model-checkbox.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: var(--text-inverse);
            box-shadow: var(--shadow-md);
        }

        .model-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .model-info {
            flex: 1;
            margin-left: var(--space-3);
        }

        .model-name {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-1);
            font-size: var(--font-size-sm);
        }

        .model-description {
            font-size: var(--font-size-xs);
            opacity: 0.7;
            line-height: var(--line-height-tight);
        }

        .model-icon {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-inverse);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .model-icon.openai { background: #10a37f; }
        .model-icon.google { background: #4285f4; }
        .model-icon.deepseek { background: #ff6b35; }
        .model-icon.anthropic { background: #d4a574; }

        /* Form Controls */
        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-label {
            display: block;
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            margin-bottom: var(--space-2);
            font-size: var(--font-size-sm);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            transition: var(--transition-base);
            background: var(--bg-primary);
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            line-height: var(--line-height-relaxed);
        }

        /* Settings Controls */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
        }

        .range-control {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .range-input {
            width: 100%;
            height: 6px;
            border-radius: var(--radius-sm);
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-base);
        }

        .range-input::-webkit-slider-thumb:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow-md);
        }

        .range-input::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-sm);
        }

        .range-value {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            text-align: center;
            font-weight: var(--font-weight-medium);
        }

        /* Send Button */
        .send-button {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: var(--text-inverse);
            border: none;
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-md);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: var(--transition-base);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            margin-top: auto;
            min-height: 48px;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .send-button:active:not(:disabled) {
            transform: translateY(0);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Right Panel - Output Area */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .output-header {
            padding: var(--space-5) var(--space-6);
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-xs);
        }

        .output-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }

        .output-subtitle {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        .output-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-6);
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .output-content::-webkit-scrollbar {
            width: 8px;
        }

        .output-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .output-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: var(--radius-full);
        }

        /* Response Cards */
        .response-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-5);
        }

        .response-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .response-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .response-header {
            padding: var(--space-4) var(--space-5);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .response-agent {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-weight: var(--font-weight-semibold);
        }

        .agent-badge {
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .agent-badge.openai { background: #10a37f; color: var(--text-inverse); }
        .agent-badge.google { background: #4285f4; color: var(--text-inverse); }
        .agent-badge.deepseek { background: #ff6b35; color: var(--text-inverse); }
        .agent-badge.anthropic { background: #d4a574; color: var(--text-inverse); }

        .response-meta {
            display: flex;
            gap: var(--space-4);
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }

        .response-body {
            padding: var(--space-5);
            line-height: var(--line-height-relaxed);
            white-space: pre-wrap;
        }

        /* Judge Section */
        .judge-section {
            margin-top: var(--space-6);
            padding: var(--space-5);
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border-radius: var(--radius-lg);
            border: 1px solid #b3d9ff;
        }

        .judge-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
        }

        .judge-button {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: var(--text-inverse);
            border: none;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-md);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: var(--transition-base);
            margin-bottom: var(--space-4);
        }

        .judge-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .judge-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .judge-results {
            display: grid;
            gap: var(--space-3);
        }

        .score-bar {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) 0;
        }

        .score-label {
            min-width: 80px;
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
        }

        .score-progress {
            flex: 1;
            height: 8px;
            background: var(--border-color);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: var(--radius-sm);
        }

        .score-value {
            min-width: 50px;
            text-align: right;
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }

        /* Audit Section */
        .audit-section {
            margin-top: var(--space-5);
            padding: var(--space-4);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .audit-title {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-3);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }

        .audit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-3);
        }

        .audit-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .audit-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: var(--font-weight-medium);
        }

        .audit-value {
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-full);
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-10);
            text-align: center;
            color: var(--text-secondary);
            justify-content: center;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-16) var(--space-5);
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: var(--font-size-3xl);
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-2);
            color: var(--text-primary);
        }

        .empty-state-description {
            font-size: var(--font-size-sm);
            line-height: var(--line-height-relaxed);
            max-width: 400px;
            margin: 0 auto;
        }

        /* Real-time Indicator */
        .real-time-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-top: var(--space-2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .left-panel {
                width: 35%;
                min-width: 320px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
                min-width: unset;
                max-width: unset;
                order: 1;
            }
            
            .pane-divider {
                display: none;
            }
            
            .right-panel {
                order: 2;
                min-height: 60vh;
            }
            
            .control-sections {
                padding: var(--space-4);
                gap: var(--space-4);
            }
            
            .output-content {
                padding: var(--space-4);
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus Styles */
        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .model-checkbox:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }

        /* Micro-interactions */
        .control-section,
        .response-card,
        .model-checkbox,
        .send-button,
        .judge-button {
            will-change: transform;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000000;
                --text-secondary: #000000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Panel Component -->
        <div id="leftPanel" class="left-panel">
            <div class="panel-header">
                <h1>🤖 Polybot Genesis</h1>
                <p>Multi-Agent AI Dispatch System</p>
            </div>
            
            <div class="control-sections">
                <!-- AI Models Section Component -->
                <div id="modelsSection" class="control-section">
                    <div class="section-title">🎯 AI Models</div>
                    <div class="models-grid" id="modelsGrid">
                        <!-- Model checkboxes will be rendered here -->
                    </div>
                    <div class="real-time-indicator">
                        <div class="status-dot"></div>
                        <span>Real-time selection updates</span>
                    </div>
                </div>

                <!-- Judge Model Section Component -->
                <div id="judgeSection" class="control-section">
                    <div class="section-title">⚖️ Judge Model</div>
                    <div class="form-group">
                        <select id="judgeModel" class="form-select" aria-label="Select judge model">
                            <option value="anthropic">Anthropic Claude (Default)</option>
                            <option value="openai">OpenAI GPT-4</option>
                            <option value="auto">Auto-Select</option>
                            <option value="none">No Judge</option>
                        </select>
                    </div>
                </div>

                <!-- Query Section Component -->
                <div id="querySection" class="control-section">
                    <div class="section-title">💬 Query</div>
                    <div class="form-group">
                        <label for="prompt" class="form-label">Enter your prompt</label>
                        <textarea 
                            id="prompt" 
                            class="form-textarea" 
                            placeholder="Ask a question, request code, or describe what you need help with..."
                            aria-describedby="prompt-help"
                            required
                        ></textarea>
                        <div id="prompt-help" class="sr-only">Enter the prompt you want to send to the AI models</div>
                    </div>
                </div>

                <!-- Settings Section Component -->
                <div id="settingsSection" class="control-section">
                    <div class="section-title">⚙️ Settings</div>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label for="temperature" class="form-label">Temperature</label>
                            <div class="range-control">
                                <input 
                                    type="range" 
                                    id="temperature" 
                                    class="range-input" 
                                    min="0" 
                                    max="1" 
                                    step="0.1" 
                                    value="0.7"
                                    aria-label="Temperature setting"
                                >
                                <div class="range-value">0.7</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="responseMode" class="form-label">Response Mode</label>
                            <select id="responseMode" class="form-select" aria-label="Select response mode">
                                <option value="brief" selected>Brief (300 tokens)</option>
                                <option value="full">Full (800 tokens)</option>
                                <option value="deepthink">Deep Think (1500 tokens)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="maxTokens" class="form-label">Max Tokens</label>
                        <div class="range-control">
                            <input 
                                type="range" 
                                id="maxTokens" 
                                class="range-input" 
                                min="100" 
                                max="2000" 
                                step="50" 
                                value="300"
                                aria-label="Maximum tokens"
                            >
                            <div class="range-value">300</div>
                        </div>
                    </div>
                </div>

                <!-- Send Button Component -->
                <button id="sendButton" class="send-button" aria-label="Send prompt to selected AI models">
                    <span>🚀</span>
                    <span>Dispatch to AI Agents</span>
                </button>
            </div>
        </div>

        <!-- Pane Divider -->
        <div class="pane-divider"></div>

        <!-- Right Panel Component -->
        <div id="rightPanel" class="right-panel">
            <div class="output-header">
                <div class="output-title">AI Responses</div>
                <div class="output-subtitle" id="outputSubtitle">Live results from your selected AI models</div>
            </div>
            
            <div class="output-content">
                <div id="resultsContainer" class="response-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">🤖</div>
                        <div class="empty-state-title">Ready to Dispatch</div>
                        <div class="empty-state-description">
                            Select your AI models, enter a prompt, and click "Dispatch to AI Agents" to see responses from multiple AI systems. Code queries will return full responses without length restrictions.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application State Management
        class AppState {
            constructor() {
                this.selectedAgents = [];
                this.selectedJudge = 'anthropic';
                this.lastDispatchData = null;
                this.isDispatching = false;
                this.prompt = '';
                this.settings = {
                    temperature: 0.7,
                    maxTokens: 300,
                    responseMode: 'brief'
                };
                this.listeners = [];
            }

            // Subscribe to state changes
            subscribe(callback) {
                this.listeners.push(callback);
                return () => {
                    this.listeners = this.listeners.filter(listener => listener !== callback);
                };
            }

            // Notify all listeners of state changes
            notify() {
                this.listeners.forEach(callback => callback(this));
            }

            // Update selected agents
            updateSelectedAgents(agents) {
                this.selectedAgents = [...agents];
                this.notify();
            }

            // Update judge selection
            updateSelectedJudge(judge) {
                this.selectedJudge = judge;
                this.notify();
            }

            // Update prompt
            updatePrompt(prompt) {
                this.prompt = prompt;
                this.notify();
            }

            // Update settings
            updateSettings(newSettings) {
                this.settings = { ...this.settings, ...newSettings };
                this.notify();
            }

            // Update dispatch state
            updateDispatchState(isDispatching, data = null) {
                this.isDispatching = isDispatching;
                if (data) this.lastDispatchData = data;
                this.notify();
            }

            // Check if code query (removes length restrictions)
            isCodeQuery() {
                const codeKeywords = ['code', 'function', 'class', 'algorithm', 'script', 'program', 'implementation', 'debug', 'refactor', 'optimize'];
                return codeKeywords.some(keyword => 
                    this.prompt.toLowerCase().includes(keyword)
                );
            }

            // Get effective token limit
            getEffectiveTokenLimit() {
                return this.isCodeQuery() ? 2000 : this.settings.maxTokens;
            }
        }

        // Initialize application state
        const appState = new AppState();

        // API Helper Functions
        function getBackendUrl() {
            const customDomain = window.REACT_APP_API_DOMAIN || '';
            const codespacesUrl = window.location.origin
                .replace(/-\d+\.app\.github\.dev/, '-3000.app.github.dev');
            
            if (window.location.hostname === 'polybot.online' || window.location.hostname.includes('vercel.app')) {
                return window.location.origin + '/api';
            }
            
            if (customDomain) return customDomain;
            if (window.location.hostname.includes('github.dev')) return codespacesUrl;
            return 'http://localhost:3000';
        }

        // Left Panel Component
        class LeftPanel {
            constructor() {
                this.models = [
                    {
                        id: 'openai',
                        name: 'OpenAI GPT-4',
                        description: 'Advanced reasoning and analysis',
                        icon: 'O'
                    },
                    {
                        id: 'google',
                        name: 'Google Gemini',
                        description: 'Multimodal AI capabilities',
                        icon: 'G'
                    },
                    {
                        id: 'deepseek',
                        name: 'DeepSeek Coder',
                        description: 'Code and technical analysis',
                        icon: 'D'
                    }
                ];
                
                this.init();
            }

            init() {
                this.renderModels();
                this.setupEventListeners();
                this.updateRangeValues();
                
                // Subscribe to state changes
                appState.subscribe(this.onStateChange.bind(this));
            }

            renderModels() {
                const modelsGrid = document.getElementById('modelsGrid');
                modelsGrid.innerHTML = this.models.map(model => `
                    <label class="model-checkbox" data-agent="${model.id}" role="checkbox" aria-checked="false" tabindex="0">
                        <input type="checkbox" name="agents" value="${model.id}" aria-hidden="true">
                        <div class="model-icon ${model.id}">${model.icon}</div>
                        <div class="model-info">
                            <div class="model-name">${model.name}</div>
                            <div class="model-description">${model.description}</div>
                        </div>
                    </label>
                `).join('');
            }

            setupEventListeners() {
                // Model selection
                document.querySelectorAll('.model-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', this.handleModelSelection.bind(this));
                    checkbox.addEventListener('keydown', this.handleModelKeydown.bind(this));
                });

                // Judge model selection
                document.getElementById('judgeModel').addEventListener('change', (e) => {
                    appState.updateSelectedJudge(e.target.value);
                });

                // Range inputs
                document.querySelectorAll('.range-input').forEach(range => {
                    range.addEventListener('input', this.handleRangeChange.bind(this));
                });

                // Response mode change
                document.getElementById('responseMode').addEventListener('change', this.handleResponseModeChange.bind(this));

                // Send button
                document.getElementById('sendButton').addEventListener('click', this.handleDispatch.bind(this));

                // Prompt textarea
                document.getElementById('prompt').addEventListener('input', (e) => {
                    appState.updatePrompt(e.target.value);
                });
            }

            handleModelSelection(event) {
                event.preventDefault();
                const checkbox = event.currentTarget;
                const agent = checkbox.dataset.agent;
                
                let newSelection = [...appState.selectedAgents];
                if (newSelection.includes(agent)) {
                    newSelection = newSelection.filter(a => a !== agent);
                } else {
                    newSelection.push(agent);
                }
                
                appState.updateSelectedAgents(newSelection);
            }

            handleModelKeydown(event) {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    this.handleModelSelection(event);
                }
            }

            handleRangeChange() {
                this.updateRangeValues();
                const temperature = parseFloat(document.getElementById('temperature').value);
                const maxTokens = parseInt(document.getElementById('maxTokens').value);
                
                appState.updateSettings({ temperature, maxTokens });
            }

            handleResponseModeChange() {
                const mode = document.getElementById('responseMode').value;
                const tokenModes = {
                    brief: 300,
                    full: 800,
                    deepthink: 1500
                };
                
                if (tokenModes[mode]) {
                    document.getElementById('maxTokens').value = tokenModes[mode];
                    this.updateRangeValues();
                }
                
                appState.updateSettings({ 
                    responseMode: mode,
                    maxTokens: tokenModes[mode] || appState.settings.maxTokens
                });
            }

            updateRangeValues() {
                document.querySelectorAll('.range-input').forEach(range => {
                    const value = range.value;
                    const valueDisplay = range.parentElement.querySelector('.range-value');
                    if (valueDisplay) {
                        valueDisplay.textContent = value;
                    }
                });
            }

            onStateChange(state) {
                // Update model selection UI
                document.querySelectorAll('.model-checkbox').forEach(checkbox => {
                    const agent = checkbox.dataset.agent;
                    const isSelected = state.selectedAgents.includes(agent);
                    
                    checkbox.classList.toggle('selected', isSelected);
                    checkbox.querySelector('input').checked = isSelected;
                    checkbox.setAttribute('aria-checked', isSelected.toString());
                });

                // Update send button
                this.updateSendButton(state);
                
                // Update output subtitle
                this.updateOutputSubtitle(state);
            }

            updateSendButton(state) {
                const sendButton = document.getElementById('sendButton');
                const hasAgents = state.selectedAgents.length > 0;
                const hasPrompt = state.prompt.trim().length > 0;
                
                sendButton.disabled = !hasAgents || !hasPrompt || state.isDispatching;
                
                if (state.isDispatching) {
                    sendButton.innerHTML = '<div class="loading-spinner"></div><span>Dispatching...</span>';
                } else {
                    sendButton.innerHTML = '<span>🚀</span><span>Dispatch to AI Agents</span>';
                }
            }

            updateOutputSubtitle(state) {
                const subtitle = document.getElementById('outputSubtitle');
                if (state.selectedAgents.length > 0) {
                    const agentNames = state.selectedAgents.map(agent => 
                        agent.charAt(0).toUpperCase() + agent.slice(1)
                    ).join(', ');
                    subtitle.textContent = `Selected: ${agentNames} • ${state.isCodeQuery() ? 'Code mode (no length limit)' : `${state.settings.maxTokens} tokens max`}`;
                } else {
                    subtitle.textContent = 'Live results from your selected AI models';
                }
            }

            async handleDispatch() {
                if (appState.isDispatching) return;
                
                const prompt = appState.prompt.trim();
                if (!prompt || appState.selectedAgents.length === 0) return;

                appState.updateDispatchState(true);

                try {
                    const backendUrl = getBackendUrl();
                    const effectiveTokens = appState.getEffectiveTokenLimit();

                    const response = await fetch(`${backendUrl}/dispatch`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            agents: appState.selectedAgents,
                            judge: appState.selectedJudge,
                            responseMode: appState.settings.responseMode,
                            temperature: appState.settings.temperature,
                            maxTokens: effectiveTokens,
                            isCodeQuery: appState.isCodeQuery()
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        appState.updateDispatchState(false, data);
                        rightPanel.displayResults(data);
                    } else {
                        throw new Error(data.error || 'Request failed');
                    }
                } catch (error) {
                    console.log('API not available, showing demo response:', error.message);
                    
                    // Fallback demo response
                    const demoResponse = this.generateDemoResponse(prompt);
                    appState.updateDispatchState(false, demoResponse);
                    rightPanel.displayResults(demoResponse);
                }
            }

            generateDemoResponse(prompt) {
                const isCode = appState.isCodeQuery();
                const effectiveTokens = appState.getEffectiveTokenLimit();
                
                const demoResponse = {
                    status: 'success',
                    prompt: prompt,
                    agents: appState.selectedAgents,
                    responseMode: appState.settings.responseMode,
                    responses: {},
                    metadata: {
                        dispatch_id: `demo_${Date.now()}`,
                        timestamp: new Date().toISOString(),
                        mode: 'demo',
                        isCodeQuery: isCode,
                        effectiveTokens: effectiveTokens
                    }
                };
                
                // Generate demo responses for selected agents
                appState.selectedAgents.forEach(agent => {
                    const baseResponse = isCode 
                        ? `// ${agent.toUpperCase()} Code Response for: "${prompt}"\n\nfunction exampleSolution() {\n    // This is a demo response showing how ${agent} would handle code queries\n    // In production, this would connect to the ${agent} API\n    // Code responses have no length restrictions\n    \n    const result = processQuery(prompt);\n    return result;\n}\n\n// Additional implementation details would be provided\n// without token limitations for code queries`
                        : `This is a demo response from ${agent.toUpperCase()} for the prompt: "${prompt}"\n\nThe actual implementation would connect to the ${agent} API to generate intelligent responses. Currently showing demo mode since the backend API is being configured.\n\nResponse details:\n- Token limit: ${effectiveTokens}\n- Mode: ${appState.settings.responseMode}\n- Temperature: ${appState.settings.temperature}`;

                    demoResponse.responses[agent] = {
                        response: baseResponse,
                        tokens: isCode ? effectiveTokens : Math.floor(Math.random() * 50) + effectiveTokens - 50,
                        timestamp: new Date().toISOString(),
                        model: agent === 'openai' ? 'gpt-4' : agent === 'google' ? 'gemini-pro' : 'deepseek-coder',
                        isCodeResponse: isCode
                    };
                });
                
                return demoResponse;
            }
        }

        // Right Panel Component
        class RightPanel {
            constructor() {
                this.init();
            }

            init() {
                // Subscribe to state changes
                appState.subscribe(this.onStateChange.bind(this));
            }

            onStateChange(state) {
                if (state.isDispatching) {
                    this.showLoadingState();
                }
            }

            showLoadingState() {
                const resultsContainer = document.getElementById('resultsContainer');
                resultsContainer.innerHTML = '<div class="loading-text"><div class="loading-spinner"></div>Dispatching to AI agents...</div>';
            }

            displayResults(data) {
                const resultsContainer = document.getElementById('resultsContainer');
                let html = '';

                // Display responses
                Object.entries(data.responses).forEach(([agent, response]) => {
                    html += `
                        <div class="response-card">
                            <div class="response-header">
                                <div class="response-agent">
                                    <span class="agent-badge ${agent}">${agent}</span>
                                    <span>${response.model || agent}</span>
                                    ${response.isCodeResponse ? '<span style="font-size: 10px; color: var(--success-color);">CODE</span>' : ''}
                                </div>
                                <div class="response-meta">
                                    <span>📊 ${response.tokens} tokens</span>
                                    <span>⏱️ ${new Date(response.timestamp).toLocaleTimeString()}</span>
                                </div>
                            </div>
                            <div class="response-body">${response.response}</div>
                        </div>
                    `;
                });

                // Add judge section if there are multiple responses
                if (Object.keys(data.responses).length > 1 && appState.selectedJudge !== 'none') {
                    html += `
                        <div class="judge-section">
                            <div class="judge-header">
                                <span>⚖️</span>
                                <span>Judge Evaluation</span>
                            </div>
                            <button class="judge-button" onclick="rightPanel.evaluateWithJudge()">
                                Evaluate Responses
                            </button>
                            <div id="judgeResults"></div>
                        </div>
                    `;
                }

                // Add audit section
                html += `
                    <div class="audit-section">
                        <div class="audit-title">📊 Audit Information</div>
                        <div class="audit-grid">
                            <div class="audit-item">
                                <div class="audit-label">Dispatch ID</div>
                                <div class="audit-value">${data.metadata.dispatch_id}</div>
                            </div>
                            <div class="audit-item">
                                <div class="audit-label">Timestamp</div>
                                <div class="audit-value">${new Date(data.metadata.timestamp).toLocaleString()}</div>
                            </div>
                            <div class="audit-item">
                                <div class="audit-label">Agents</div>
                                <div class="audit-value">${data.agents.length}</div>
                            </div>
                            <div class="audit-item">
                                <div class="audit-label">Mode</div>
                                <div class="audit-value">${data.metadata.mode || 'live'}</div>
                            </div>
                            <div class="audit-item">
                                <div class="audit-label">Token Limit</div>
                                <div class="audit-value">${data.metadata.effectiveTokens || 'default'}</div>
                            </div>
                            <div class="audit-item">
                                <div class="audit-label">Query Type</div>
                                <div class="audit-value">${data.metadata.isCodeQuery ? 'Code' : 'Text'}</div>
                            </div>
                        </div>
                    </div>
                `;

                resultsContainer.innerHTML = html;
            }

            async evaluateWithJudge() {
                if (!appState.lastDispatchData) return;

                const judgeButton = document.querySelector('.judge-button');
                const judgeResults = document.getElementById('judgeResults');
                
                judgeButton.disabled = true;
                judgeButton.textContent = 'Evaluating...';

                try {
                    const backendUrl = getBackendUrl();
                    const response = await fetch(`${backendUrl}/judge`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: appState.lastDispatchData.prompt,
                            responses: appState.lastDispatchData.responses,
                            judge: appState.selectedJudge
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        this.displayJudgeResults(data);
                    } else {
                        throw new Error(data.error || 'Judge evaluation failed');
                    }
                } catch (error) {
                    console.log('Judge API not available, showing demo evaluation:', error.message);
                    this.displayJudgeResults(this.generateDemoJudgeResult());
                } finally {
                    judgeButton.disabled = false;
                    judgeButton.textContent = 'Evaluate Responses';
                }
            }

            generateDemoJudgeResult() {
                const agents = Object.keys(appState.lastDispatchData.responses);
                const randomWinner = agents[Math.floor(Math.random() * agents.length)];
                
                const demoJudgeResult = {
                    status: 'success',
                    judge: appState.selectedJudge || 'anthropic',
                    winner: randomWinner,
                    reasoning: `After analyzing all responses, ${randomWinner.toUpperCase()} provided the most comprehensive and accurate answer. The response demonstrated strong understanding of the prompt and delivered practical, well-structured information. ${appState.lastDispatchData.metadata.isCodeQuery ? 'Special consideration given for code quality and implementation detail.' : ''} (Demo evaluation)`,
                    scores: {},
                    timestamp: new Date().toISOString(),
                    mode: 'demo'
                };
                
                // Generate demo scores
                agents.forEach(agent => {
                    demoJudgeResult.scores[agent] = Math.random() * 0.3 + 0.7;
                });
                demoJudgeResult.scores[randomWinner] = Math.max(demoJudgeResult.scores[randomWinner], 0.85);
                
                return demoJudgeResult;
            }

            displayJudgeResults(data) {
                const judgeResults = document.getElementById('judgeResults');
                
                let html = `
                    <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--bg-primary); border-radius: var(--radius-md); border: 1px solid #b3d9ff;">
                        <strong>🏆 Winner: ${data.winner.toUpperCase()}</strong>
                    </div>
                    
                    <div class="judge-results">
                `;

                // Display scores with animation
                Object.entries(data.scores).forEach(([agent, score]) => {
                    const percentage = Math.round(score * 100);
                    html += `
                        <div class="score-bar">
                            <div class="score-label">${agent.toUpperCase()}</div>
                            <div class="score-progress">
                                <div class="score-fill" style="width: ${percentage}%"></div>
                            </div>
                            <div class="score-value">${percentage}%</div>
                        </div>
                    `;
                });

                html += `
                    </div>
                    
                    <div style="margin-top: var(--space-4); padding: var(--space-3); background: var(--bg-primary); border-radius: var(--radius-md); border: 1px solid #b3d9ff; font-style: italic;">
                        <strong>Reasoning:</strong><br>
                        ${data.reasoning}
                    </div>
                `;

                judgeResults.innerHTML = html;
            }
        }

        // Initialize Components
        let leftPanel, rightPanel;

        function initializeApp() {
            leftPanel = new LeftPanel();
            rightPanel = new RightPanel();
            
            console.log('🚀 Polybot Genesis initialized with component architecture');
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Export for global access
        window.appState = appState;
        window.leftPanel = leftPanel;
        window.rightPanel = rightPanel;
    </script>
</body>
</html>
